name: ğŸš€ WOLOF-SIGN CI/CD

on:
  push:
    branches: [prod]

jobs:
  tests:
    name: ğŸ§ª Tests Django
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: wolofuser
          POSTGRES_PASSWORD: wolof@123
          POSTGRES_DB: wolofsign
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ—ï¸ Setup environment
      run: |
        echo "DEBUG=True" > .env
        echo "SECRET_KEY=test-secret-key" >> .env
        echo "DB_NAME=wolofsign" >> .env
        echo "DB_USER=wolofuser" >> .env
        echo "DB_PASSWORD=wolof@123" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_PORT=5432" >> .env

    - name: ğŸ—ƒï¸ Run migrations
      run: |
        python manage.py migrate
      
    - name: ğŸ§ª Run tests
      run: |
        python manage.py test

  deploy-production:
    name: ğŸš€ DÃ©ploiement Production
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/prod'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: ğŸš€ Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} '
            set -e
            echo "ğŸš€ DÃ©ploiement Wolof-Sign en cours..."
            
            cd /var/www/wolof-sign
            
            echo "ğŸ“¥ RÃ©cupÃ©ration du code..."
            git fetch origin prod
            git reset --hard origin/prod
            git clean -fd
            
            echo "ğŸ³ Reconstruction des services..."
            docker-compose -f docker-compose.final.yml down
            docker-compose -f docker-compose.final.yml build --no-cache
            
            echo "ğŸš€ DÃ©marrage des services..."
            docker-compose -f docker-compose.final.yml up -d
            sleep 30
            
            echo "ğŸ—ƒï¸ ExÃ©cution des migrations..."
            docker-compose -f docker-compose.final.yml exec web python manage.py migrate --noinput
            
            echo "ğŸ“¦ Collection des fichiers statiques..."
            docker-compose -f docker-compose.final.yml exec web python manage.py collectstatic --noinput --clear
            
            echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI!"
            echo "ğŸŒ Votre application est accessible sur:"
            echo "   http://72.60.189.237:8080/"
            echo "   http://72.60.189.237:8080/api/docs/"
          '
