  name: ğŸš€ WOLOF-SIGN CI/CD

  on:
    push:
      branches: [main, prod]
    pull_request:
      branches: [main, prod]

  env:
    PYTHON_VERSION: '3.11'
    DJANGO_ENV: 'test'

  jobs:
    tests:
      name: ğŸ§ª Tests Django
      runs-on: ubuntu-latest
      timeout-minutes: 10
      
      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_USER: wolofuser
            POSTGRES_PASSWORD: wolof@123
            POSTGRES_DB: wolofsign
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 5432:5432

      steps:
      - name: ğŸ“¥  Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django coverage
      - name: ğŸ—ï¸ Create environment file
        run: |
          echo "DEBUG=False" >> .env.test
          echo "SECRET_KEY=test-key-for-github-actions-only" >> .env.test
          echo "DB_NAME=wolofsign" >> .env.test
          echo "DB_USER=wolofuser" >> .env.test
          echo "DB_PASSWORD=Bamsachine97@123" >> .env.test
          echo "DB_HOST=localhost" >> .env.test
          echo "DB_PORT=5432" >> .env.test
      - name: ğŸ—ƒï¸ Setup test database
        run: |
          python manage.py migrate
        env:
          DJANGO_SETTINGS_MODULE: core.settings

    code-quality:
      name: ğŸ”  QualitÃ© de Code
      runs-on: ubuntu-latest
      
      steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install quality tools
        run: |
          pip install black flake8 isort
      - name: ğŸ¨ Code formatting
        run: |
          black --check --diff . || echo "âš ï¸  Formatting issues found"
    
          
    deploy-production:
      name: ğŸš€ DÃ©ploiement Production
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/prod'  # â­ DÃ©ployer seulement sur prod
      
      steps:
        - name: ğŸ“¥ Checkout code
          uses: actions/checkout@v4
          
        - name: ğŸ§ª Debug Secrets
          run: |
            echo "HOST = '${{ secrets.VPS_HOST }}'"
            echo "USERNAME = '${{ secrets.VPS_USERNAME }}'"
            if [ -z "${{ secrets.VPS_HOST }}" ]; then
              echo "âŒ VPS_HOST is EMPTY"
              exit 1
            fi
          shell: bash


        - name: ğŸš€ Deploy with SSH Key
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              set -e
              echo "ğŸš€ Starting deployment..."
              cd /var/www/wolof-sign
              
              echo "ğŸ“¥ Cleaning and fetching latest code..."
              git fetch origin prod
              git reset --hard origin/prod
              git clean -fd
              
              echo "ğŸ³ Rebuilding Docker images..."
              docker-compose down
              docker-compose build --no-cache web
              
              echo "ğŸš€ Starting services..."
              docker-compose up -d db redis web
              sleep 15
              
              echo "ğŸ” Checking web status..."
              docker-compose logs web --tail=10
              
              echo "ğŸ—ƒï¸ Running migrations..."
              docker-compose exec web python manage.py migrate --noinput
              
              echo "ğŸ“¦ Collecting static files..."
              docker-compose exec web python manage.py collectstatic --noinput
              
              echo "ğŸ”§ Starting nginx..."
              docker-compose up -d nginx
              
              echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
              docker-compose ps
              echo "âœ… Health check..."
              curl -f http://localhost:8000/health/ || echo "Health check endpoint not available"
