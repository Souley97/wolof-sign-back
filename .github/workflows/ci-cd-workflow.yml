  name: ğŸš€ WOLOF-SIGN CI/CD

  on:
    push:
      branches: [main, prod]
    pull_request:
      branches: [main, prod]

  env:
    PYTHON_VERSION: '3.11'
    DJANGO_ENV: 'test'

  jobs:
    tests:
      name: ğŸ§ª Tests Django
      runs-on: ubuntu-latest
      timeout-minutes: 10
      
      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_USER: wolofuser
            POSTGRES_PASSWORD: wolof@123
            POSTGRES_DB: wolofsign
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 5432:5432

      steps:
      - name: ğŸ“¥  Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django coverage
      - name: ğŸ—ï¸ Create environment file
        run: |
          echo "DEBUG=False" >> .env.test
          echo "SECRET_KEY=test-key-for-github-actions-only" >> .env.test
          echo "DB_NAME=wolofsign" >> .env.test
          echo "DB_USER=wolofuser" >> .env.test
          echo "DB_PASSWORD=Bamsachine97@123" >> .env.test
          echo "DB_HOST=localhost" >> .env.test
          echo "DB_PORT=5432" >> .env.test
      - name: ğŸ—ƒï¸ Setup test database
        run: |
          python manage.py migrate
        env:
          DJANGO_SETTINGS_MODULE: core.settings

    code-quality:
      name: ğŸ”  QualitÃ© de Code
      runs-on: ubuntu-latest
      
      steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install quality tools
        run: |
          pip install black flake8 isort
      - name: ğŸ¨ Code formatting
        run: |
          black --check --diff . || echo "âš ï¸  Formatting issues found"
    
          
    deploy-production:
      name: ğŸ§ª Debug Secrets
      run: |
        echo "HOST = '${{ secrets.VPS_HOST }}'"
        echo "USERNAME = '${{ secrets.VPS_USERNAME }}'"
        if [ -z "${{ secrets.VPS_HOST }}" ]; then
          echo "âŒ VPS_HOST is EMPTY"
          exit 1
        fi
      shell: bash
